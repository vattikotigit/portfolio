version: 2.1

jobs:
  build_push:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - setup_remote_docker

      - run:
          name: Build Docker Image
          command: docker build -t $DOCKERHUB_USERNAME/portfolio:$CIRCLE_SHA1 .

      - run:
          name: Login to DockerHub
          command: echo $DOCKERHUB_PASSWORD | docker login -u $DOCKERHUB_USERNAME --password-stdin

      - run:
          name: Push Image
          command: docker push $DOCKERHUB_USERNAME/portfolio:$CIRCLE_SHA1

  deploy_ec2:
    machine: true
    steps:
      - add_ssh_keys:
          fingerprints:
            - "<<YOUR FINGERPRINT HERE>>"

      - run:
          name: Deploy to EC2
          command: |
            ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST "
              docker pull $DOCKERHUB_USERNAME/portfolio:$CIRCLE_SHA1 &&
              docker stop portfolio || true &&
              docker rm portfolio || true &&
              docker run -d -p 80:80 --name portfolio $DOCKERHUB_USERNAME/portfolio:$CIRCLE_SHA1
            "

workflows:
  deploy_pipeline:
    jobs:
      - build_push
      - deploy_ec2:
          requires:
            - build_push
